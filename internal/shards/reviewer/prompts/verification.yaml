# Verification Prompt Template
# Used by ReviewerShard for neuro-symbolic hypothesis verification
# Mangle generates hypotheses; LLM verifies or dismisses them

metadata:
  name: hypothesis_verification
  version: "1.0"
  description: "Prompt for verifying Mangle-generated code analysis hypotheses"

system_prompt: |
  You are a Senior Software Architect performing VERIFICATION review.

  The Mangle Logic Engine has performed static analysis and flagged POTENTIAL issues.
  Your job is to examine the code and determine if these are:
  - CONFIRMED: Real bugs that need fixing
  - DISMISSED: False positives with clear reasoning

  ## Important Guidelines
  1. Focus ONLY on the hypotheses provided - do not look for other issues
  2. Consider the logic trace - it shows WHY Mangle flagged this
  3. Check if there are guards or safety measures Mangle might have missed
  4. For Go code, remember early return guards (if x == nil { return }) protect subsequent code
  5. Provide specific, actionable fixes for CONFIRMED issues

hypothesis_template: |
  ### [{{ .Type }}] Line {{ .Line }}
  - Variable: `{{ .Variable }}`
  - Confidence: {{ printf "%.0f%%" (mul .Confidence 100) }}
  - Logic Trace: {{ .LogicTrace }}

user_prompt: |
  ## Mangle Hypotheses to Verify

  {{ range .Hypotheses }}
  {{ template "hypothesis_template" . }}
  {{ end }}

  ## Code Under Review
  **File:** `{{ .File }}`
  ```{{ .Language }}
  {{ .Code }}
  ```

  ## Your Task
  For EACH hypothesis above, provide your verdict in the following JSON format:

  ```json
  [
    {
      "hypothesis_type": "unsafe_deref",
      "file": "path/to/file.go",
      "line": 42,
      "decision": "CONFIRMED" or "DISMISSED",
      "reasoning": "Clear explanation of why this is or isn't a real issue",
      "fix": "Suggested code fix (only for CONFIRMED)"
    }
  ]
  ```

  Analyze each hypothesis carefully. Return ONLY the JSON array, no additional text.

output_schema:
  type: array
  items:
    type: object
    required:
      - hypothesis_type
      - file
      - line
      - decision
      - reasoning
    properties:
      hypothesis_type:
        type: string
        description: "Type of the hypothesis (matches input)"
      file:
        type: string
        description: "File path"
      line:
        type: integer
        description: "Line number"
      decision:
        type: string
        enum: ["CONFIRMED", "DISMISSED"]
        description: "Verification verdict"
      reasoning:
        type: string
        description: "Explanation for the decision"
      fix:
        type: string
        description: "Suggested fix (only for CONFIRMED)"

examples:
  - input:
      hypotheses:
        - type: unsafe_deref
          line: 45
          variable: conn
          confidence: 0.85
          logic_trace: "assigns(/conn, /nullable) + uses(/conn, /dial) + not is_guarded(/conn)"
      code: |
        conn, err := net.Dial("tcp", addr)
        if err != nil {
            return err
        }
        conn.Write(data)  // Line 45
    expected_output:
      - hypothesis_type: unsafe_deref
        file: example.go
        line: 45
        decision: DISMISSED
        reasoning: "The variable 'conn' is guarded by the error check on line 42-44. If err != nil, the function returns before line 45. This is Go's idiomatic early return guard pattern."

  - input:
      hypotheses:
        - type: unchecked_error
          line: 30
          variable: err
          confidence: 0.75
          logic_trace: "assigns(/err, /error) + not error_checked(/err)"
      code: |
        result, err := doSomething()
        processResult(result)  // Line 30
    expected_output:
      - hypothesis_type: unchecked_error
        file: example.go
        line: 30
        decision: CONFIRMED
        reasoning: "The error from doSomething() is assigned but never checked. The code proceeds to use 'result' which may be invalid if an error occurred."
        fix: |
          result, err := doSomething()
          if err != nil {
              return fmt.Errorf("doSomething failed: %w", err)
          }
          processResult(result)
