# AUTOGENERATED FROM MARKDOWN: this file was converted from a .md atom doc
# Source: engine/gas_limits.md

- id: "language/mangle/docs/engine/gas_limits"
  category: "language"
  subcategory: "mangle"
  description: "Mangle Engine: Gas Limits and Resource Control"
  priority: 30
  is_mandatory: false
  languages: ["/mangle"]
  content: |
    # Mangle Engine: Gas Limits and Resource Control
    
    ## Fact Creation Limits
    
    Mangle provides **fact creation limits** as the primary resource control mechanism. This is analogous to "gas limits" in other systems.
    
    ### WithCreatedFactLimit
    
    ```go
    EvalOption: WithCreatedFactLimit(maxFacts int64)
    ```
    
    This evaluation option limits the maximum number of facts created during evaluation.
    
    ### Why Fact Limits Are Needed
    
    While pure Datalog guarantees termination, Mangle's extensions can break this:
    
    1. **Function calls** - May generate infinite sequences
    2. **Aggregation** - May require unbounded computation
    3. **Recursive rules with functions** - Can create infinite fact streams
    4. **Unbounded recursion** - Without base cases or limits
    
    ### Example: Unbounded Recursion
    
    ```mangle
    # DANGEROUS: Infinite recursion
    count(N) :- count(M), N = fn:plus(M, 1).
    ```
    
    This rule will generate facts forever: `count(1)`, `count(2)`, `count(3)`, ... until the fact limit is reached.
    
    ### Correct Pattern: Bounded Recursion
    
    ```mangle
    # SAFE: Bounded by finite domain
    count(N) :- count(M), N = fn:plus(M, 1), N < 100.
    count(0).
    ```
    
    Always ensure recursion is bounded by:
    - A finite domain (e.g., `N < 100`)
    - A base case that terminates
    - A limit condition
    
    ## Resource Exhaustion Behavior
    
    When the fact limit is exceeded:
    
    1. **Evaluation stops** - No more facts are derived
    2. **Error is returned** - The caller receives an error
    3. **Partial results** - Facts derived up to the limit remain in the store
    
    ### Setting Appropriate Limits
    
    Choose limits based on:
    
    - **Expected dataset size** - How many facts should reasonably exist?
    - **Memory constraints** - How much RAM is available?
    - **Computation time** - How long should evaluation run?
    - **Safety margin** - Add buffer for unexpected growth
    
    ### Example Usage
    
    ```go
    import "github.com/google/mangle/engine"
    
    // Limit to 1 million facts
    opts := []engine.EvalOption{
        engine.WithCreatedFactLimit(1_000_000),
    }
    
    err := engine.EvalProgramWithStats(program, facts, opts...)
    if err != nil {
        // Handle error - possibly fact limit exceeded
    }
    ```
    
    ## Other Resource Considerations
    
    While Mangle currently exposes fact limits, implementations should also consider:
    
    1. **Memory usage** - Fact stores consume RAM proportional to fact count
    2. **Evaluation time** - Complex rules may take significant CPU time
    3. **Stack depth** - Recursive evaluation may require stack space
    
    Future versions may add additional `EvalOption` values for these resources.
    
    ## Termination Properties
    
    ### Pure Datalog
    - **Guaranteed termination** - Always reaches fixpoint
    - **No resource limits needed** - Will always finish
    - **Predictable behavior** - Same inputs â†’ same outputs, always
    
    ### Mangle with Extensions
    - **Termination NOT guaranteed** - May run forever
    - **Resource limits required** - Use `WithCreatedFactLimit`
    - **Careful rule design** - Ensure bounded recursion
    
    ## Best Practices
    
    1. **Always set fact limits** in production code
    2. **Start conservative** - Use lower limits during development
    3. **Monitor statistics** - Use `EvalProgramWithStats` to track growth
    4. **Test edge cases** - Ensure rules terminate with unexpected inputs
    5. **Bound all recursion** - Never write unbounded recursive rules
