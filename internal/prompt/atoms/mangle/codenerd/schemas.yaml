# AUTOGENERATED FROM MARKDOWN: this file was converted from a .md atom doc
# Source: codenerd/schemas.md

- id: "language/mangle/docs/codenerd/schemas"
  category: "language"
  subcategory: "mangle"
  description: "codeNERD Mangle Schemas (EDB Declarations)"
  priority: 30
  is_mandatory: false
  languages: ["/mangle"]
  content: |
    # codeNERD Mangle Schemas (EDB Declarations)
    
    Complete reference of all Extensional Database (EDB) predicate declarations used in codeNERD.
    
    ## Overview
    
    EDB predicates are **declared** using `Decl` statements and **populated** with facts from external sources (filesystem scans, LSP, user input, etc.). They form the base layer of the knowledge graph.
    
    ## Schema Organization
    
    Schemas are organized into 10 logical sections mirroring the codeNERD architecture.
    
    ---
    
    ## SECTION 1: Intent & Focus (Perception Layer Output)
    
    ### user_intent/5
    
    The seed fact for all logic. Captures parsed user intent from natural language input.
    
    ```mangle
    Decl user_intent(
        ID.Type<n>,
        Category.Type<n>,      # /query, /mutation, /instruction
        Verb.Type<n>,          # /explain, /refactor, /debug, /generate, /scaffold
        Target.Type<string>,   # "auth system", "login button"
        Constraint.Type<string> # "no external libs", "max_complexity < 10"
    ).
    ```
    
    **Category Values**:
    - `/query` - Read-only information requests
    - `/mutation` - State-altering requests (file writes, git commits)
    - `/instruction` - New rules, preferences, or configuration changes
    
    **Common Verb Values**:
    - `/explain`, `/refactor`, `/debug`, `/generate`, `/generate_test`
    - `/scaffold`, `/define_agent`, `/fix`, `/explore`, `/review`
    - `/security`, `/analyze`, `/search`, `/research`, `/init`
    
    **Examples**:
    ```mangle
    user_intent(/u1, /mutation, /fix, "auth.go", "preserve existing error handling").
    user_intent(/u2, /query, /explain, "src/main.go", "").
    user_intent(/u3, /mutation, /refactor, "database layer", "use repository pattern").
    ```
    
    ### focus_resolution/4
    
    Maps fuzzy user references to concrete filesystem paths and symbols.
    
    ```mangle
    Decl focus_resolution(
        RawReference.Type<string>,  # "the auth thing"
        ResolvedPath.Type<string>,  # "src/auth/handler.go"
        SymbolName.Type<string>,    # "AuthHandler"
        ConfidencePercent.Type<int> # 0 - 100
    ).
    ```
    
    **Examples**:
    ```mangle
    focus_resolution("the auth thing", "src/auth/handler.go", "AuthHandler", 92).
    focus_resolution("login button", "ui/login.go", "LoginButton", 65).
    ```
    
    **Triggers Clarification**:
    ```mangle
    clarification_needed(Ref) :-
        focus_resolution(Ref, _, _, Score),
        Score < 85.
    ```
    
    ### ambiguity_flag/3
    
    Marks holes in the knowledge graph requiring user clarification.
    
    ```mangle
    Decl ambiguity_flag(
        MissingParam.Type<string>,   # "TargetFunction"
        ContextClue.Type<string>,    # Part of prompt hinting at missing data
        Hypothesis.Type<string>      # LLM's best guess
    ).
    ```
    
    **Examples**:
    ```mangle
    ambiguity_flag("target_file", "mentioned 'the handler'", "auth/handler.go").
    ambiguity_flag("branch_name", "no branch specified", "feature/auth-refactor").
    ```
    
    ---
    
    ## SECTION 2: World Model - File System
    
    ### file_topology/5
    
    Fact-based filesystem representation. Core EDB for all file-related logic.
    
    ```mangle
    Decl file_topology(
        Path.Type<string>,           # Unique identifier
        Hash.Type<string>,           # SHA-256 for change detection
        Language.Type<n>,            # /go, /python, /ts, /rust, /unknown
        LastModified.Type<int>,      # Unix timestamp
        IsTestFile.Type<n>           # /true or /false
    ).
    ```
    
    **Examples**:
    ```mangle
    file_topology("src/main.go", "a3f4b2c1...", /go, 1702345678, /false).
    file_topology("src/main_test.go", "d7e8f9a0...", /go, 1702345679, /true).
    file_topology("README.md", "1a2b3c4d...", /markdown, 1702345680, /false).
    ```
    
    **Language Values**: `/go`, `/python`, `/typescript`, `/javascript`, `/rust`, `/c`, `/cpp`, `/java`, `/markdown`, `/json`, `/yaml`, `/unknown`
    
    ### file_content/4
    
    File content chunks for large files (windowing pattern).
    
    ```mangle
    Decl file_content(
        Path.Type<string>,
        StartLine.Type<int>,
        EndLine.Type<int>,
        Content.Type<string>
    ).
    ```
    
    **Examples**:
    ```mangle
    file_content("src/main.go", 1, 100, "package main\n\nimport ...").
    file_content("src/main.go", 101, 200, "func main() {\n...").
    ```
    
    ### file_imports/3
    
    Import/dependency relationships between files.
    
    ```mangle
    Decl file_imports(
        SourcePath.Type<string>,
        ImportPath.Type<string>,
        ImportType.Type<n>           # /direct, /transitive
    ).
    ```
    
    **Examples**:
    ```mangle
    file_imports("src/main.go", "src/auth/handler.go", /direct).
    file_imports("src/main.go", "encoding/json", /direct).
    ```
    
    ---
    
    ## SECTION 3: World Model - Symbol Graph
    
    ### symbol_graph/5
    
    AST projection for semantic reasoning about code symbols.
    
    ```mangle
    Decl symbol_graph(
        SymbolID.Type<string>,       # "func:main:AuthHandler"
        Type.Type<n>,                # /function, /class, /interface, /variable
        Visibility.Type<n>,          # /public, /private, /protected
        DefinedAt.Type<string>,      # Path + Line Number
        Signature.Type<string>       # "(User) -> Result<bool>"
    ).
    ```
    
    **Symbol Types**: `/function`, `/class`, `/interface`, `/struct`, `/variable`, `/constant`, `/method`, `/property`
    
    **Visibility Types**: `/public`, `/private`, `/protected`, `/internal`
    
    **Examples**:
    ```mangle
    symbol_graph("func:main:AuthHandler", /function, /public, "src/auth/handler.go:42", "(req Request) Response").
    symbol_graph("struct:User", /struct, /public, "src/models/user.go:10", "{ID int, Name string}").
    symbol_graph("var:config", /variable, /private, "src/config.go:5", "Config").
    ```
    
    ### dependency_link/3
    
    Call graph - symbol A calls/uses symbol B.
    
    ```mangle
    Decl dependency_link(
        CallerID.Type<string>,
        CalleeID.Type<string>,
        ImportPath.Type<string>
    ).
    ```
    
    **Examples**:
    ```mangle
    dependency_link("func:main:main", "func:auth:AuthHandler", "src/auth").
    dependency_link("func:auth:AuthHandler", "func:db:Query", "src/db").
    ```
    
    ### symbol_reference/4
    
    Where symbols are referenced/used in code.
    
    ```mangle
    Decl symbol_reference(
        SymbolID.Type<string>,
        FilePath.Type<string>,
        Line.Type<int>,
        Column.Type<int>
    ).
    ```
    
    **Examples**:
    ```mangle
    symbol_reference("func:auth:AuthHandler", "src/main.go", 42, 15).
    symbol_reference("struct:User", "src/handlers/user.go", 18, 8).
    ```
    
    ---
    
    ## SECTION 4: Diagnostics
    
    ### diagnostic/5
    
    Compiler/linter errors as logical constraints. Enables "Linter-Logic Bridge".
    
    ```mangle
    Decl diagnostic(
        Severity.Type<n>,            # /panic, /error, /warning, /info
        FilePath.Type<string>,
        Line.Type<int>,
        ErrorCode.Type<string>,      # E0308 (Rust), TS2322 (TypeScript)
        Message.Type<string>
    ).
    ```
    
    **Severity Levels**: `/panic`, `/error`, `/warning`, `/info`
    
    **Examples**:
    ```mangle
    diagnostic(/error, "src/main.go", 42, "undefined: DoThing", "undefined variable or function").
    diagnostic(/warning, "src/auth.go", 15, "SA1019", "deprecated function usage").
    diagnostic(/panic, "src/db.go", 88, "nil pointer dereference", "runtime panic").
    ```
    
    **The Commit Barrier**:
    ```mangle
    block_commit("Build Broken") :-
        diagnostic(/error, _, _, _, _).
    
    git_commit_allowed() :-
        not block_commit(_).
    ```
    
    ### test_result/5
    
    Test execution results.
    
    ```mangle
    Decl test_result(
        TestName.Type<string>,
        FilePath.Type<string>,
        Status.Type<n>,              # /passed, /failed, /skipped, /panic
        Duration.Type<int>,          # Milliseconds
        Message.Type<string>
    ).
    ```
    
    **Examples**:
    ```mangle
    test_result("TestAuthHandler", "src/auth/handler_test.go", /passed, 42, "").
    test_result("TestDBQuery", "src/db/db_test.go", /failed, 88, "expected 5, got 3").
    test_result("TestIntegration", "tests/integration_test.go", /panic, 1, "nil pointer dereference").
    ```
    
    ---
    
    ## SECTION 5: TDD Loop State
    
    ### test_state/1
    
    Current TDD loop state for repair orchestration.
    
    ```mangle
    Decl test_state(State.Type<n>).
    ```
    
    **States**: `/passing`, `/failing`, `/compiling`, `/unknown`, `/log_read`, `/cause_found`, `/patch_applied`
    
    **Examples**:
    ```mangle
    test_state(/failing).
    test_state(/passing).
    ```
    
    ### next_action/1
    
    Mangle-derived next action (IDB typically, but also used as fact).
    
    ```mangle
    Decl next_action(Action.Type<n>).
    ```
    
    **Common Actions**: `/read_error_log`, `/analyze_root_cause`, `/generate_patch`, `/run_tests`, `/escalate_to_user`
    
    ### permitted/1
    
    Constitutional safety gate - actions permitted by policy.
    
    ```mangle
    Decl permitted(Action.Type<n>).
    ```
    
    **Examples**:
    ```mangle
    permitted(/read_file).
    permitted(/write_file).
    permitted(/run_tests).
    ```
    
    ---
    
    ## SECTION 6: Shard Management
    
    ### shard_profile/4
    
    Specialist shard capabilities and configuration.
    
    ```mangle
    Decl shard_profile(
        AgentName.Type<n>,           # /agent_rust, /agent_k8s
        Description.Type<string>,    # Mission statement
        Topics.Type<string>,         # JSON array of research topics
        Tools.Type<string>           # JSON array of tool names
    ).
    ```
    
    **Examples**:
    ```mangle
    shard_profile(/agent_rust, "Rust specialist agent", "[\"ownership\",\"lifetimes\"]", "[\"cargo\",\"rustfmt\"]").
    shard_profile(/agent_k8s, "Kubernetes specialist", "[\"deployments\",\"services\"]", "[\"kubectl\"]").
    ```
    
    ### delegate_task/3
    
    Tasks delegated to shards for execution.
    
    ```mangle
    Decl delegate_task(
        ShardType.Type<n>,
        Task.Type<string>,
        Priority.Type<int>
    ).
    ```
    
    **Examples**:
    ```mangle
    delegate_task(/reviewer, "review auth.go for security issues", 100).
    delegate_task(/tester, "run integration tests", 90).
    ```
    
    ### shard_status/3
    
    Current shard execution status.
    
    ```mangle
    Decl shard_status(
        AgentName.Type<n>,
        Status.Type<n>,              # /idle, /running, /completed, /failed
        LastActive.Type<int>         # Unix timestamp
    ).
    ```
    
    **Examples**:
    ```mangle
    shard_status(/reviewer, /running, 1702345678).
    shard_status(/tester, /completed, 1702345679).
    ```
    
    ---
    
    ## SECTION 7: Research & Knowledge
    
    ### knowledge_atom/4
    
    Extracted knowledge from ResearcherShard ingestion.
    
    ```mangle
    Decl knowledge_atom(
        SourceURL.Type<string>,
        Concept.Type<string>,
        CodePattern.Type<string>,
        AntiPattern.Type<string>
    ).
    ```
    
    **Examples**:
    ```mangle
    knowledge_atom("https://rust-lang.org/ownership", "ownership", "let x = 5;", "let mut x; x = 5;").
    knowledge_atom("https://go.dev/errors", "error handling", "if err != nil { return err }", "panic(err)").
    ```
    
    ### research_topic/3
    
    Active research topics for specialist agents.
    
    ```mangle
    Decl research_topic(
        AgentName.Type<n>,
        Topic.Type<string>,
        Status.Type<n>               # /pending, /in_progress, /completed
    ).
    ```
    
    **Examples**:
    ```mangle
    research_topic(/agent_rust, "ownership patterns", /completed).
    research_topic(/agent_k8s, "helm chart best practices", /in_progress).
    ```
    
    ### doc_reference/3
    
    External documentation sources.
    
    ```mangle
    Decl doc_reference(
        Library.Type<string>,
        URL.Type<string>,
        LastFetched.Type<int>        # Unix timestamp
    ).
    ```
    
    **Examples**:
    ```mangle
    doc_reference("Rust", "https://doc.rust-lang.org/book/", 1702345678).
    doc_reference("Kubernetes", "https://kubernetes.io/docs/", 1702345679).
    ```
    
    ---
    
    ## SECTION 8: Observations & Memory
    
    ### observation/2
    
    Runtime observations and facts.
    
    ```mangle
    Decl observation(
        Key.Type<n>,
        Value.Type<string>
    ).
    ```
    
    **Examples**:
    ```mangle
    observation(/current_branch, "feature/auth-refactor").
    observation(/last_commit, "a3f4b2c1").
    observation(/test_coverage, "85%").
    ```
    
    ### preference/2
    
    Learned user preferences (autopoiesis).
    
    ```mangle
    Decl preference(
        Key.Type<n>,
        Value.Type<string>
    ).
    ```
    
    **Examples**:
    ```mangle
    preference(/test_style, "table_driven").
    preference(/error_handling, "wrap_errors").
    preference(/commit_style, "conventional").
    ```
    
    ### activation/3
    
    Spreading activation weights for context selection.
    
    ```mangle
    Decl activation(
        Concept.Type<string>,
        Weight.Type<float>,
        Source.Type<n>               # /recency, /goal, /dependency
    ).
    ```
    
    **Examples**:
    ```mangle
    activation("src/auth/handler.go", 1.0, /recency).
    activation("src/db/query.go", 0.7, /dependency).
    activation("tool:go_test", 0.8, /goal).
    ```
    
    ---
    
    ## SECTION 9: Campaign & Goals
    
    ### campaign/3
    
    Multi-phase goal orchestration.
    
    ```mangle
    Decl campaign(
        ID.Type<n>,
        Goal.Type<string>,
        Status.Type<n>               # /active, /paused, /completed, /failed
    ).
    ```
    
    **Examples**:
    ```mangle
    campaign(/c1, "Implement authentication system", /active).
    campaign(/c2, "Refactor database layer", /completed).
    ```
    
    ### campaign_phase/4
    
    Individual campaign phases.
    
    ```mangle
    Decl campaign_phase(
        CampaignID.Type<n>,
        PhaseNum.Type<int>,
        Description.Type<string>,
        Status.Type<n>
    ).
    ```
    
    **Examples**:
    ```mangle
    campaign_phase(/c1, 1, "Design auth schema", /completed).
    campaign_phase(/c1, 2, "Implement handlers", /active).
    campaign_phase(/c1, 3, "Write tests", /pending).
    ```
    
    ### phase_depends/3
    
    Phase ordering constraints (dependency graph).
    
    ```mangle
    Decl phase_depends(
        CampaignID.Type<n>,
        Phase.Type<int>,
        DependsOn.Type<int>
    ).
    ```
    
    **Examples**:
    ```mangle
    phase_depends(/c1, 2, 1).  # Phase 2 depends on Phase 1
    phase_depends(/c1, 3, 2).  # Phase 3 depends on Phase 2
    ```
    
    ---
    
    ## SECTION 10: Autopoiesis (Tool Generation)
    
    ### generated_tool/4
    
    Dynamically generated tools via Ouroboros.
    
    ```mangle
    Decl generated_tool(
        Name.Type<string>,
        Description.Type<string>,
        Schema.Type<string>,         # JSON schema
        Status.Type<n>               # /generated, /validated, /deployed, /failed
    ).
    ```
    
    **Examples**:
    ```mangle
    generated_tool("validate_json", "Validates JSON schema", "{...}", /deployed).
    generated_tool("format_go", "Formats Go code", "{...}", /validated).
    ```
    
    ### tool_invocation/3
    
    Tool usage history for quality tracking.
    
    ```mangle
    Decl tool_invocation(
        ToolName.Type<string>,
        Timestamp.Type<int>,
        Success.Type<n>              # /true or /false
    ).
    ```
    
    **Examples**:
    ```mangle
    tool_invocation("validate_json", 1702345678, /true).
    tool_invocation("format_go", 1702345679, /false).
    ```
    
    ### tool_quality/3
    
    Tool effectiveness metrics.
    
    ```mangle
    Decl tool_quality(
        ToolName.Type<string>,
        SuccessRate.Type<float>,     # 0.0 - 1.0
        AvgDuration.Type<int>        # Milliseconds
    ).
    ```
    
    **Examples**:
    ```mangle
    tool_quality("validate_json", 0.95, 42).
    tool_quality("format_go", 0.88, 150).
    ```
    
    ---
    
    ## SECTION 11: Taxonomy & Intent Classification
    
    ### verb_def/4
    
    Verb taxonomy definitions.
    
    ```mangle
    Decl verb_def(
        Verb.Type<n>,
        Category.Type<n>,
        ShardType.Type<n>,
        Priority.Type<int>
    ).
    ```
    
    **Examples**:
    ```mangle
    verb_def(/review, /query, /reviewer, 100).
    verb_def(/fix, /mutation, /coder, 90).
    verb_def(/explain, /query, /none, 80).
    ```
    
    ### verb_synonym/2
    
    Verb synonyms for NL parsing.
    
    ```mangle
    Decl verb_synonym(
        Verb.Type<n>,
        Synonym.Type<string>
    ).
    ```
    
    **Examples**:
    ```mangle
    verb_synonym(/review, "audit").
    verb_synonym(/review, "code review").
    verb_synonym(/fix, "repair").
    ```
    
    ### verb_pattern/2
    
    Regex patterns for verb detection.
    
    ```mangle
    Decl verb_pattern(
        Verb.Type<n>,
        Regex.Type<string>
    ).
    ```
    
    **Examples**:
    ```mangle
    verb_pattern(/review, "(?i)review.*(file|code)").
    verb_pattern(/fix, "(?i)fix.*bug").
    ```
    
    ### candidate_intent/2
    
    Candidate intents with raw scores (transient).
    
    ```mangle
    Decl candidate_intent(
        Verb.Type<n>,
        RawScore.Type<float>
    ).
    ```
    
    ### context_token/1
    
    Tokenized user input for classification (transient).
    
    ```mangle
    Decl context_token(Token.Type<string>).
    ```
    
    ### user_input_string/1
    
    Full user input string (transient).
    
    ```mangle
    Decl user_input_string(Input.Type<string>).
    ```
    
    ### learned_exemplar/5
    
    Learned user patterns from autopoiesis.
    
    ```mangle
    Decl learned_exemplar(
        Pattern.Type<string>,
        Verb.Type<n>,
        Target.Type<string>,
        Constraint.Type<string>,
        ConfidencePercent.Type<int> # 0 - 100
    ).
    ```
    
    **Examples**:
    ```mangle
    learned_exemplar("push to github", /git, "remote", "push", 95).
    learned_exemplar("run the tests", /test, "all", "", 90).
    ```
    
    ---
    
    ## SECTION 12: Autopoiesis State (Ouroboros Loop)
    
    ### state/3
    
    Ouroboros loop transactional state.
    
    ```mangle
    Decl state(
        StepID.Type<n>,
        Stability.Type<float>,
        Location.Type<string>
    ).
    ```
    
    ### proposed/1
    
    Proposed next state in Ouroboros loop.
    
    ```mangle
    Decl proposed(StepID.Type<n>).
    ```
    
    ### history/2
    
    Code hash history for stagnation detection.
    
    ```mangle
    Decl history(
        StepID.Type<n>,
        Hash.Type<string>
    ).
    ```
    
    ### error_event/1
    
    Error events in Ouroboros loop.
    
    ```mangle
    Decl error_event(Type.Type<n>).
    ```
    
    ### iteration/2
    
    Iteration tracking for Ouroboros loop.
    
    ```mangle
    Decl iteration(
        StepID.Type<n>,
        IterNum.Type<int>
    ).
    ```
    
    ### retry_attempt/3
    
    Retry tracking with reasons.
    
    ```mangle
    Decl retry_attempt(
        StepID.Type<n>,
        AttemptNum.Type<int>,
        Reason.Type<string>
    ).
    ```
    
    ### base_stability/2
    
    Base stability score before penalties.
    
    ```mangle
    Decl base_stability(
        StepID.Type<n>,
        Score.Type<float>
    ).
    ```
    
    ### tool_hot_loaded/2
    
    Hot-reloaded tool tracking.
    
    ```mangle
    Decl tool_hot_loaded(
        ToolName.Type<string>,
        Timestamp.Type<int>
    ).
    ```
    
    ---
    
    ## Usage Guidelines
    
    1. **Always declare before use**: Every predicate MUST have a `Decl` statement before facts can be asserted.
    
    2. **Type consistency**: Ensure fact arguments match declared types:
       - `Type<n>` = Name constant (atom) like `/go`, `/mutation`
       - `Type<string>` = String literals like `"path/to/file"`
       - `Type<int>` = Integers like `42`, `1702345678`
       - `Type<float>` = Floats like `0.95`, `1.0`
    
    3. **Atoms vs Strings**:
       - Use `/atom` syntax for enums, categories, states
       - Use `"string"` for freeform text, paths, messages
    
    4. **Fact insertion**:
       ```go
       engine.AddFact("file_topology", "src/main.go", "a3f4b2c1", "/go", 1702345678, "/false")
       ```
    
    5. **Query pattern**:
       ```go
       result, _ := engine.Query(ctx, "file_topology(Path, _, /go, _, _)")
       ```
    
    ## See Also
    
    - [policy.md](policy.md) - IDB derivation rules
    - [predicates_reference.md](predicates_reference.md) - Predicate purpose and usage
    - [fact_patterns.md](fact_patterns.md) - How to create facts
    - [query_patterns.md](query_patterns.md) - Common query patterns
