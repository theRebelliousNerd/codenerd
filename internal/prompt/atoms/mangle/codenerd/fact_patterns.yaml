# AUTOGENERATED FROM MARKDOWN: this file was converted from a .md atom doc
# Source: codenerd/fact_patterns.md

- id: "language/mangle/docs/codenerd/fact_patterns"
  category: "language"
  subcategory: "mangle"
  description: "Mangle Fact Creation Patterns for codeNERD"
  priority: 30
  is_mandatory: false
  languages: ["/mangle"]
  content: |
    # Mangle Fact Creation Patterns for codeNERD
    
    Comprehensive guide to creating facts for every codeNERD predicate. Shows exact Go code patterns for fact insertion.
    
    ## Core Principles
    
    1. **Type Matching**: Arguments must match the `Decl` type exactly
    2. **Atom Syntax**: Use `/atom` for Names, `"string"` for Strings
    3. **Auto-Atomization**: Identifier-like strings may be auto-converted to atoms
    4. **Explicit Types**: When in doubt, be explicit about types
    
    ## Go Integration Patterns
    
    ### Basic Fact Insertion
    
    ```go
    // AddFact(predicate string, args ...interface{})
    engine.AddFact("file_topology",
        "src/main.go",        // Path (String)
        "a3f4b2c1",           // Hash (String)
        "/go",                // Language (Name)
        1702345678,           // LastModified (Int)
        "/false")             // IsTestFile (Name)
    ```
    
    ### Batch Insertion
    
    ```go
    facts := []mangle.Fact{
        {Predicate: "file_topology", Args: []interface{}{"src/main.go", "hash1", "/go", 1702345678, "/false"}},
        {Predicate: "file_topology", Args: []interface{}{"src/db.go", "hash2", "/go", 1702345679, "/false"}},
    }
    engine.AddFacts(facts)
    ```
    
    ### Type-Safe Fact Creation
    
    ```go
    // Using mangle.Fact struct
    fact := mangle.Fact{
        Predicate: "user_intent",
        Args: []interface{}{
            "/u1",               // ID - atom
            "/mutation",         // Category - atom
            "/fix",              // Verb - atom
            "auth.go",           // Target - string
            "preserve errors",   // Constraint - string
        },
    }
    engine.AddFact(fact.Predicate, fact.Args...)
    ```
    
    ---
    
    ## Intent & Focus Predicates
    
    ### user_intent/5
    
    ```go
    // Basic intent
    engine.AddFact("user_intent",
        "/u1",          // ID
        "/mutation",    // Category: /query, /mutation, /instruction
        "/fix",         // Verb: /fix, /review, /explain, etc.
        "auth.go",      // Target
        "")             // Constraint (empty if none)
    
    // Intent with constraints
    engine.AddFact("user_intent",
        "/u2",
        "/mutation",
        "/refactor",
        "database layer",
        "use repository pattern, no breaking changes")
    
    // Query intent
    engine.AddFact("user_intent",
        "/u3",
        "/query",
        "/explain",
        "src/main.go",
        "")
    ```
    
    ### focus_resolution/4
    
    ```go
    // High-confidence resolution
    engine.AddFact("focus_resolution",
        "the auth thing",           // RawReference
        "src/auth/handler.go",      // ResolvedPath
        "AuthHandler",              // SymbolName
        0.92)                       // Confidence (float)
    
    // Low-confidence (triggers clarification)
    engine.AddFact("focus_resolution",
        "login",
        "ui/login.go",
        "LoginButton",
        0.65)  // < 0.85 triggers clarification_needed
    ```
    
    ### ambiguity_flag/3
    
    ```go
    engine.AddFact("ambiguity_flag",
        "target_file",              // MissingParam
        "mentioned 'the handler'",  // ContextClue
        "auth/handler.go")          // Hypothesis
    ```
    
    ---
    
    ## File System Predicates
    
    ### file_topology/5
    
    ```go
    // Regular file
    engine.AddFact("file_topology",
        "src/main.go",
        "a3f4b2c15d...",  // SHA-256 hash
        "/go",            // Language
        1702345678,       // Unix timestamp
        "/false")         // IsTestFile
    
    // Test file
    engine.AddFact("file_topology",
        "src/main_test.go",
        "d7e8f9a012...",
        "/go",
        1702345679,
        "/true")  // IsTestFile = true
    
    // Non-Go file
    engine.AddFact("file_topology",
        "README.md",
        "1a2b3c4d56...",
        "/markdown",
        1702345680,
        "/false")
    ```
    
    **Language Values**: `/go`, `/python`, `/typescript`, `/javascript`, `/rust`, `/c`, `/cpp`, `/java`, `/markdown`, `/json`, `/yaml`, `/unknown`
    
    ### file_content/4
    
    ```go
    // Chunk 1
    engine.AddFact("file_content",
        "src/main.go",
        1,      // StartLine
        100,    // EndLine
        "package main\n\nimport ...")
    
    // Chunk 2
    engine.AddFact("file_content",
        "src/main.go",
        101,
        200,
        "func main() {\n...")
    ```
    
    ### file_imports/3
    
    ```go
    // Direct import
    engine.AddFact("file_imports",
        "src/main.go",           // SourcePath
        "src/auth/handler.go",   // ImportPath
        "/direct")               // ImportType
    
    // Standard library import
    engine.AddFact("file_imports",
        "src/main.go",
        "encoding/json",
        "/direct")
    ```
    
    ### modified/1
    
    ```go
    engine.AddFact("modified", "src/auth/handler.go")
    ```
    
    ---
    
    ## Symbol Graph Predicates
    
    ### symbol_graph/5
    
    ```go
    // Function definition
    engine.AddFact("symbol_graph",
        "func:main:AuthHandler",        // SymbolID
        "/function",                    // Type
        "/public",                      // Visibility
        "src/auth/handler.go:42",       // DefinedAt
        "(req Request) Response")       // Signature
    
    // Struct definition
    engine.AddFact("symbol_graph",
        "struct:User",
        "/struct",
        "/public",
        "src/models/user.go:10",
        "{ID int, Name string}")
    
    // Private variable
    engine.AddFact("symbol_graph",
        "var:config",
        "/variable",
        "/private",
        "src/config.go:5",
        "Config")
    ```
    
    **Symbol Types**: `/function`, `/class`, `/struct`, `/interface`, `/variable`, `/constant`, `/method`, `/property`
    
    **Visibility**: `/public`, `/private`, `/protected`, `/internal`
    
    ### dependency_link/3
    
    ```go
    engine.AddFact("dependency_link",
        "func:main:main",           // CallerID
        "func:auth:AuthHandler",    // CalleeID
        "src/auth")                 // ImportPath
    ```
    
    ### symbol_reference/4
    
    ```go
    engine.AddFact("symbol_reference",
        "func:auth:AuthHandler",    // SymbolID
        "src/main.go",              // FilePath
        42,                         // Line
        15)                         // Column
    ```
    
    ---
    
    ## Diagnostic Predicates
    
    ### diagnostic/5
    
    ```go
    // Error
    engine.AddFact("diagnostic",
        "/error",                   // Severity
        "src/main.go",
        42,                         // Line
        "undefined: DoThing",       // ErrorCode
        "undefined variable or function")  // Message
    
    // Warning
    engine.AddFact("diagnostic",
        "/warning",
        "src/auth.go",
        15,
        "SA1019",
        "deprecated function usage")
    
    // Panic
    engine.AddFact("diagnostic",
        "/panic",
        "src/db.go",
        88,
        "nil pointer dereference",
        "runtime panic: invalid memory address")
    ```
    
    **Severity**: `/panic`, `/error`, `/warning`, `/info`
    
    ### test_result/5
    
    ```go
    // Passing test
    engine.AddFact("test_result",
        "TestAuthHandler",          // TestName
        "src/auth/handler_test.go", // FilePath
        "/passed",                  // Status
        42,                         // Duration (ms)
        "")                         // Message
    
    // Failing test
    engine.AddFact("test_result",
        "TestDBQuery",
        "src/db/db_test.go",
        "/failed",
        88,
        "expected 5, got 3")
    
    // Panicking test
    engine.AddFact("test_result",
        "TestIntegration",
        "tests/integration_test.go",
        "/panic",
        1,
        "nil pointer dereference")
    ```
    
    **Status**: `/passed`, `/failed`, `/skipped`, `/panic`
    
    ---
    
    ## TDD Loop Predicates
    
    ### test_state/1
    
    ```go
    engine.AddFact("test_state", "/failing")
    engine.AddFact("test_state", "/passing")
    engine.AddFact("test_state", "/log_read")
    engine.AddFact("test_state", "/cause_found")
    ```
    
    **States**: `/passing`, `/failing`, `/compiling`, `/unknown`, `/log_read`, `/cause_found`, `/patch_applied`
    
    ### permitted/3
    
    ```go
    engine.AddFact("permitted", "/read_file", "main.go", "")
    engine.AddFact("permitted", "/write_test_file", "test.go", "")
    engine.AddFact("permitted", "/run_tests", "", "")
    ```
    
    ---
    
    ## Shard Predicates
    
    ### shard_profile/4
    
    ```go
    import "encoding/json"
    
    topics := []string{"ownership", "lifetimes", "borrowing"}
    tools := []string{"cargo", "rustfmt", "clippy"}
    
    topicsJSON, _ := json.Marshal(topics)
    toolsJSON, _ := json.Marshal(tools)
    
    engine.AddFact("shard_profile",
        "/agent_rust",              // AgentName
        "Rust specialist agent",    // Description
        string(topicsJSON),         // Topics (JSON)
        string(toolsJSON))          // Tools (JSON)
    ```
    
    ### delegate_task/3
    
    ```go
    engine.AddFact("delegate_task",
        "/reviewer",                // ShardType
        "review auth.go for security issues",
        100)                        // Priority
    ```
    
    ### shard_status/3
    
    ```go
    engine.AddFact("shard_status",
        "/reviewer",
        "/running",
        1702345678)  // Unix timestamp
    ```
    
    **Status**: `/idle`, `/running`, `/completed`, `/failed`
    
    ---
    
    ## Research & Knowledge Predicates
    
    ### knowledge_atom/4
    
    ```go
    engine.AddFact("knowledge_atom",
        "https://rust-lang.org/ownership",
        "ownership",
        "let x = 5;",
        "let mut x; x = 5;")
    ```
    
    ### research_topic/3
    
    ```go
    engine.AddFact("research_topic",
        "/agent_rust",
        "ownership patterns",
        "/completed")
    ```
    
    **Status**: `/pending`, `/in_progress`, `/completed`
    
    ### doc_reference/3
    
    ```go
    engine.AddFact("doc_reference",
        "Rust",
        "https://doc.rust-lang.org/book/",
        1702345678)
    ```
    
    ---
    
    ## Memory & Context Predicates
    
    ### observation/2
    
    ```go
    engine.AddFact("observation",
        "/current_branch",
        "feature/auth-refactor")
    
    engine.AddFact("observation",
        "/last_commit",
        "a3f4b2c1")
    ```
    
    ### preference/2
    
    ```go
    engine.AddFact("preference",
        "/test_style",
        "table_driven")
    
    engine.AddFact("preference",
        "/error_handling",
        "wrap_errors")
    ```
    
    ### activation/3
    
    ```go
    // Recency activation
    engine.AddFact("activation",
        "src/auth/handler.go",
        1.0,
        "/recency")
    
    // Dependency activation
    engine.AddFact("activation",
        "src/db/query.go",
        0.7,
        "/dependency")
    
    // Goal activation
    engine.AddFact("activation",
        "tool:go_test",
        0.8,
        "/goal")
    ```
    
    **Source**: `/recency`, `/goal`, `/dependency`
    
    ---
    
    ## Campaign Predicates
    
    ### campaign/3
    
    ```go
    engine.AddFact("campaign",
        "/c1",
        "Implement authentication system",
        "/active")
    ```
    
    **Status**: `/active`, `/paused`, `/completed`, `/failed`
    
    ### campaign_phase/4
    
    ```go
    engine.AddFact("campaign_phase",
        "/c1",              // CampaignID
        1,                  // PhaseNum
        "Design auth schema",
        "/completed")
    
    engine.AddFact("campaign_phase",
        "/c1",
        2,
        "Implement handlers",
        "/active")
    ```
    
    ### phase_depends/3
    
    ```go
    // Phase 2 depends on Phase 1
    engine.AddFact("phase_depends",
        "/c1",  // CampaignID
        2,      // Phase
        1)      // DependsOn
    ```
    
    ---
    
    ## Verb Taxonomy Predicates
    
    ### verb_def/4
    
    ```go
    engine.AddFact("verb_def",
        "/review",      // Verb
        "/query",       // Category
        "/reviewer",    // ShardType
        100)            // Priority
    ```
    
    ### verb_synonym/2
    
    ```go
    engine.AddFact("verb_synonym",
        "/review",
        "audit")
    
    engine.AddFact("verb_synonym",
        "/review",
        "code review")
    ```
    
    ### verb_pattern/2
    
    ```go
    engine.AddFact("verb_pattern",
        "/review",
        "(?i)review.*(file|code)")  // Regex pattern
    ```
    
    ### learned_exemplar/5
    
    ```go
    engine.AddFact("learned_exemplar",
        "push to github",   // Pattern
        "/git",             // Verb
        "remote",           // Target
        "push",             // Constraint
        0.95)               // Confidence
    ```
    
    ---
    
    ## Autopoiesis Predicates (Ouroboros)
    
    ### state/3
    
    ```go
    engine.AddFact("state",
        "/step1",           // StepID
        0.85,               // Stability (float)
        "internal/autopoiesis/tool_gen.go")
    ```
    
    ### proposed/1
    
    ```go
    engine.AddFact("proposed", "/step2")
    ```
    
    ### history/2
    
    ```go
    engine.AddFact("history",
        "/step1",
        "a3f4b2c1")  // Code hash
    ```
    
    ### error_event/1
    
    ```go
    engine.AddFact("error_event", "/panic")
    engine.AddFact("error_event", "/compile_error")
    ```
    
    ### iteration/2
    
    ```go
    engine.AddFact("iteration",
        "/step1",
        5)  // IterNum
    ```
    
    ### retry_attempt/3
    
    ```go
    engine.AddFact("retry_attempt",
        "/step1",       // StepID
        2,              // AttemptNum
        "parse error")  // Reason
    ```
    
    ### base_stability/2
    
    ```go
    engine.AddFact("base_stability",
        "/step1",
        0.90)
    ```
    
    ### error_history/3
    
    ```go
    engine.AddFact("error_history",
        "/step1",
        "/panic",
        1702345678)  // Timestamp
    ```
    
    ### tool_hot_loaded/2
    
    ```go
    engine.AddFact("tool_hot_loaded",
        "validate_json",
        1702345678)
    ```
    
    ---
    
    ## Generated Tool Predicates
    
    ### generated_tool/4
    
    ```go
    schema := `{"type": "object", "properties": {...}}`
    
    engine.AddFact("generated_tool",
        "validate_json",            // Name
        "Validates JSON schema",    // Description
        schema,                     // Schema (JSON string)
        "/deployed")                // Status
    ```
    
    **Status**: `/generated`, `/validated`, `/deployed`, `/failed`
    
    ### tool_invocation/3
    
    ```go
    engine.AddFact("tool_invocation",
        "validate_json",
        1702345678,     // Timestamp
        "/true")        // Success
    ```
    
    ### tool_quality/3
    
    ```go
    engine.AddFact("tool_quality",
        "validate_json",
        0.95,           // SuccessRate (float)
        42)             // AvgDuration (ms)
    ```
    
    ---
    
    ## Common Patterns
    
    ### Conditional Fact Insertion
    
    ```go
    if isTestFile(path) {
        engine.AddFact("file_topology", path, hash, lang, timestamp, "/true")
    } else {
        engine.AddFact("file_topology", path, hash, lang, timestamp, "/false")
    }
    ```
    
    ### Batch Insert from Slice
    
    ```go
    var facts []mangle.Fact
    for _, file := range files {
        facts = append(facts, mangle.Fact{
            Predicate: "file_topology",
            Args: []interface{}{file.Path, file.Hash, file.Lang, file.Timestamp, file.IsTest},
        })
    }
    engine.AddFacts(facts)
    ```
    
    ### Timestamp Generation
    
    ```go
    import "time"
    
    timestamp := time.Now().Unix()
    engine.AddFact("diagnostic", "/error", "src/main.go", 42, "E001", "syntax error")
    ```
    
    ### JSON Encoding for Structured Data
    
    ```go
    import "encoding/json"
    
    topics := []string{"rust", "ownership"}
    data, _ := json.Marshal(topics)
    engine.AddFact("shard_profile", "/agent_rust", "Rust specialist", string(data), "[]")
    ```
    
    ---
    
    ## Type Conversion Helpers
    
    ### Booleans to Atoms
    
    ```go
    func boolToAtom(b bool) string {
        if b {
            return "/true"
        }
        return "/false"
    }
    
    engine.AddFact("file_topology", path, hash, lang, ts, boolToAtom(isTest))
    ```
    
    ### Enums to Atoms
    
    ```go
    type Severity int
    const (
        Info Severity = iota
        Warning
        Error
        Panic
    )
    
    func severityToAtom(s Severity) string {
        switch s {
        case Panic: return "/panic"
        case Error: return "/error"
        case Warning: return "/warning"
        default: return "/info"
        }
    }
    
    engine.AddFact("diagnostic", severityToAtom(sev), file, line, code, msg)
    ```
    
    ---
    
    ## Error Handling
    
    ```go
    if err := engine.AddFact("file_topology", path, hash, lang, ts, isTest); err != nil {
        log.Printf("Failed to add fact: %v", err)
        // Common errors:
        // - Predicate not declared
        // - Wrong arity
        // - Type mismatch
    }
    ```
    
    ## See Also
    
    - [schemas.md](schemas.md) - Predicate declarations
    - [predicates_reference.md](predicates_reference.md) - Predicate documentation
    - [integration_points.md](integration_points.md) - Go integration patterns
    - [validation_rules.md](validation_rules.md) - Common errors
