- id: "campaign/librarian/layers"
  category: "campaign"
  subcategory: "librarian"
  priority: 97
  is_mandatory: true
  shard_types: ["librarian"]
  campaign_phases: ["taxonomy"]
  operational_modes: ["classification"]
  description: "The Six Sacred Layers - detailed specification of scaffold, domain_core, data_layer, service, transport, and integration layers with signs of life and anti-patterns"
  content: |
    // =============================================================================
    // II. THE SIX SACRED LAYERS (DETAILED SPECIFICATION)
    // =============================================================================

    ### LAYER 1: /scaffold (The Foundation)
    **Concept**: The bedrock upon which the application sits. These are not the application itself, but the tools required to build, deploy, and configure it.
    **Primary Characteristics**:
    - Often not Go code (YAML, Dockerfile, Makefiles).
    - If Go code, it deals with "flags", "env vars", "signals", or "initialization".
    - It knows nothing of the business domain.
    **Signs of Life (Keywords & Imports)**:
    - "Dockerfile", "docker-compose", "Makefile", "go.mod", "go.sum", ".gitignore"
    - Imports: "os", "flag", "github.com/joho/godotenv", "github.com/spf13/viper"
    - Functions: "LoadConfig", "Initialize", "Setup", "Teardown"
    **Anti-Patterns**:
    - Business logic in a Makefile (Shell scripts doing too much).
    - Database connection strings hardcoded in configuration loaders.
    - "Golden Files" for testing often reside here or in /integration, but are classified as /scaffold if they are build artifacts.

    ### LAYER 2: /domain_core (The Inner Circle)
    **Concept**: The Platonic Ideals of the business. This layer defines WHAT the business is, without caring HOW it is stored or served.
    **Primary Characteristics**:
    - Pure Go code.
    - ZERO dependencies on external infrastructure (no SQL, no HTTP, no Redis).
    - Defines 'structs', 'interfaces', 'constants', and 'errors'.
    - Contains pure business rules (e.g., "A password must be 8 chars").
    **Signs of Life (Keywords & Imports)**:
    - Imports: "time", "errors", "math", "fmt" (Standard Lib only).
    - Definitions: "type User struct", "type UserRepository interface", "var ErrInvalidInput"
    - NO "sql.DB", NO "http.Request", NO "json.Marshal" (usually).
    **Anti-Patterns**:
    - A Domain Entity with a 'Save()' method (Active Record pattern is forbidden; use Repository pattern).
    - Importing "gorm" or "sqlx" tags in domain structs (leaky abstraction, though tolerated in some pragmatic codebases, strictly penalize here if pure).

    ### LAYER 3: /data_layer (The Persistence Mechanism)
    **Concept**: The materialization of the domain into bits and bytes. This layer implements the interfaces defined in the Domain Core.
    **Primary Characteristics**:
    - Knows about SQL, NoSQL, Filesystems, and S3.
    - Imports database drivers.
    - Maps domain entities to database rows (DTOs).
    **Signs of Life (Keywords & Imports)**:
    - Imports: "database/sql", "github.com/lib/pq", "gorm.io/gorm", "go.mongodb.org/mongo-driver"
    - Structs: "UserDAO", "PostgresRepository", "RedisCache"
    - SQL Queries: "SELECT * FROM", "INSERT INTO", "UPDATE"
    **Anti-Patterns**:
    - HTTP logic in a repository.
    - Returning 'sql.Rows' directly to the service layer (must map to Domain Entities first).

    ### LAYER 4: /service (The Business Logic)
    **Concept**: The Conductor. This layer orchestrates the flow of data between the Domain and the Data Layer. It implements the "Use Cases".
    **Primary Characteristics**:
    - Does not know about HTTP (no 'w http.ResponseWriter').
    - Does not know about SQL (no 'rows.Scan').
    - Focuses on "Transactions", "Workflows", and "Policies".
    - Calls methods on the interfaces defined in Domain Core.
    **Signs of Life (Keywords & Imports)**:
    - Structs: "UserService", "BillingOrchestrator", "AccountManager"
    - Methods: "RegisterUser", "ProcessPayment", "GenerateReport"
    - Logic: "if user.Balance < amount { return ErrInsufficientFunds }"
    **Anti-Patterns**:
    - Direct SQL queries in a service methods.
    - Reading "r.FormValue" in a service method (Context coupling).

    ### LAYER 5: /transport (The Interface)
    **Concept**: The Gateway. This layer exposes the application to the outside world. It translates external signals (HTTP, gRPC, CLI) into internal service calls.
    **Primary Characteristics**:
    - Heavily dependent on "net/http", "github.com/gin-gonic/gin", "google.golang.org/grpc".
    - Handles parsing (JSON decoding), validation, and serialization (JSON encoding).
    - Maps "HTTP Error" (404, 500) from Domain Errors.
    **Signs of Life (Keywords & Imports)**:
    - Imports: "net/http", "encoding/json", "github.com/spf13/cobra" (for CLI)
    - Functions: "HandleLogin", "ServeHTTP", "ExecuteCommand"
    - Variables: "mux", "router", "endpoint"
    **Anti-Patterns**:
    - Business logic in a handler (e.g., calculating tax inside the HTTP handler).
    - Direct database access from a handler.

    ### LAYER 6: /integration (The Wiring)
    **Concept**: The Assembler. This layer brings everything together. It instantiates the database, creates the repositories, injects them into services, and mounts the services to the transport.
    **Primary Characteristics**:
    - Contains 'main.go'.
    - Contains E2E tests calls.
    - Contains "Dependency Injection" logic (Wire, Dig, or manual 'NewService(NewRepo(db))').
    **Signs of Life (Keywords & Imports)**:
    - Functions: "main()", "inject()", "wire()", "Bootstrap()"
    - Code that imports ALL other layers.
    **Anti-Patterns**:
    - Defining a struct inside 'main.go'.
    - Global variables used for wiring.
