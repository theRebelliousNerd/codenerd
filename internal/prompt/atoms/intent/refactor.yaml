# Refactor Intent Verb Atoms
# Refactoring patterns, safe transformations, code smell detection

- id: "intent/refactor/core"
  category: "intent"
  subcategory: "refactor"
  priority: 95
  is_mandatory: true
  intent_verbs: ["/refactor"]
  content: |
    ## REFACTOR INTENT PROTOCOL (Encyclopedic)

    Your intent is to **REFACTOR** — improve structure, clarity, or performance **without changing externally observable behavior**.

    ### Golden Rule
    Behavior must remain identical. Any semantic change requires explicit user intent (/fix, /create).

    ### Encyclopedic Refactor Workflow
    1. **Stabilize**
       - Ensure tests pass *before* you begin.
       - If tests are failing, enter TDD repair first.
    2. **Identify target smell**
       - Long function, duplicate logic, leaky abstraction, tight coupling, poor naming.
       - State the exact improvement goal.
    3. **Map blast radius**
       - Identify direct + transitive dependents (imports/callers).
       - Avoid signature changes unless necessary.
    4. **Plan reversible steps**
       - Break into micro‑diffs (<20 LOC when possible).
       - Each step should compile independently.
    5. **Execute with verification**
       - Apply one step → run/mentally validate tests → continue.
       - Prefer extraction/inlining moves over novel rewrites.
    6. **Preserve fences**
       - Follow Chesterton’s Fence: do not delete code you can’t justify.
       - Unused wiring must be investigated before removal.
    7. **Finalize**
       - Re‑run full test suite.
       - Update docs/PRD refs if structure moved.

    ### Safety Checklist
    - [ ] No new features or behavior toggles introduced
    - [ ] Public API stability preserved (or migration documented)
    - [ ] Tests unchanged except where strictly required to reflect structure
    - [ ] No new import cycles
    - [ ] Error semantics unchanged (messages and types)

- id: "intent/refactor/patterns"
  category: "intent"
  subcategory: "refactor"
  priority: 90
  is_mandatory: false
  intent_verbs: ["/refactor"]
  depends_on: ["intent/refactor/core"]
  content: |
    ## REFACTORING PATTERNS

    ### EXTRACT METHOD
    When: Block of code can be named
    ```go
    // Before
    func process(items []Item) {
        for _, item := range items {
            // 20 lines of validation
            // 20 lines of transformation
        }
    }

    // After
    func process(items []Item) {
        for _, item := range items {
            if err := validate(item); err != nil {
                continue
            }
            transform(item)
        }
    }
    ```

    ### INLINE VARIABLE
    When: Variable adds no clarity
    ```go
    // Before
    basePrice := product.BasePrice()
    return basePrice

    // After
    return product.BasePrice()
    ```

    ### REPLACE CONDITIONAL WITH POLYMORPHISM
    When: Switch on type is scattered
    ```go
    // Before
    func area(shape Shape) float64 {
        switch s := shape.(type) {
        case Circle: return math.Pi * s.R * s.R
        case Square: return s.Side * s.Side
        }
    }

    // After - behavior on types
    type Shape interface { Area() float64 }
    func (c Circle) Area() float64 { return math.Pi * c.R * c.R }
    func (s Square) Area() float64 { return s.Side * s.Side }
    ```

- id: "intent/refactor/smells"
  category: "intent"
  subcategory: "refactor"
  priority: 85
  is_mandatory: false
  intent_verbs: ["/refactor"]
  content: |
    ## CODE SMELL DETECTION

    ### HIGH-PRIORITY SMELLS
    1. **Long Method** (>30 lines): Extract methods
    2. **Large Class** (>300 lines): Extract class
    3. **Long Parameter List** (>4 params): Introduce parameter object
    4. **Duplicate Code**: Extract to shared function
    5. **Feature Envy**: Move method to the class it envies

    ### MEDIUM-PRIORITY SMELLS
    1. **Comments explaining "what"**: Refactor for clarity
    2. **Dead Code**: Delete it
    3. **Speculative Generality**: Remove unused abstractions
    4. **Middle Man**: Inline delegation

    ### SMELL SEVERITY
    - **Critical**: Causes bugs (duplicated validation)
    - **High**: Slows development (spaghetti code)
    - **Medium**: Reduces clarity (poor names)
    - **Low**: Style issues (inconsistent formatting)
