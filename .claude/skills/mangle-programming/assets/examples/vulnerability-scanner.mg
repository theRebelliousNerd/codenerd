# Vulnerability Scanner Example
# Demonstrates dependency analysis and CVE propagation
# A complete, runnable Mangle program for security analysis
#
# Mangle v0.4.0 compatible

# =============================================================================
# Schema: Base Facts (EDB)
# =============================================================================

# Projects in the codebase
Decl project(ID, Name)
    descr [doc("Projects in the codebase")]
    bound [/name, /string].

# Direct JAR dependencies
Decl contains_jar_directly(Project, JarName, Version)
    descr [doc("Direct JAR dependencies")]
    bound [/name, /string, /string].

# Project-to-project dependencies
Decl project_depends(Dependent, Dependency)
    descr [doc("Project dependencies")]
    bound [/name, /name].

# Known CVEs affecting specific library versions
Decl cve_affects(Library, Version, CVE, Severity)
    descr [doc("CVEs affecting library versions")]
    bound [/string, /string, /string, /name].

# Patched versions
Decl patched_version(Library, Version)
    descr [doc("Patched library versions")]
    bound [/string, /string].

# =============================================================================
# Sample Data
# =============================================================================

# Projects
project(/proj/webapp, "Web Application").
project(/proj/api, "REST API").
project(/proj/core, "Core Library").
project(/proj/auth, "Authentication Module").

# Dependencies between projects
project_depends(/proj/webapp, /proj/api).
project_depends(/proj/webapp, /proj/auth).
project_depends(/proj/api, /proj/core).
project_depends(/proj/auth, /proj/core).

# Direct JAR dependencies
contains_jar_directly(/proj/core, "log4j", "2.14.0").
contains_jar_directly(/proj/core, "jackson", "2.12.0").
contains_jar_directly(/proj/api, "spring-web", "5.3.0").
contains_jar_directly(/proj/auth, "bcrypt", "0.9.0").

# Known CVEs
cve_affects("log4j", "2.14.0", "CVE-2021-44228", /critical).
cve_affects("log4j", "2.14.1", "CVE-2021-44228", /critical).
cve_affects("log4j", "2.15.0", "CVE-2021-45046", /high).
cve_affects("jackson", "2.12.0", "CVE-2020-36518", /high).

# Patched versions
patched_version("log4j", "2.17.1").
patched_version("log4j", "2.12.4").
patched_version("log4j", "2.3.2").
patched_version("jackson", "2.14.0").

# =============================================================================
# Rules: Derived Facts (IDB)
# =============================================================================

# Transitive dependency resolution
contains_jar(P, Name, Version) :-
    contains_jar_directly(P, Name, Version).

contains_jar(P, Name, Version) :-
    project_depends(P, Q),
    contains_jar(Q, Name, Version).

# Find projects with vulnerable dependencies
vulnerable_project(Project, Library, Version, CVE, Severity) :-
    project(Project, _),
    contains_jar(Project, Library, Version),
    cve_affects(Library, Version, CVE, Severity),
    !patched_version(Library, Version).

# Critical vulnerabilities only
critical_vulnerability(Project, Library, CVE) :-
    vulnerable_project(Project, Library, _, CVE, /critical).

# Count vulnerabilities per project
vulnerability_count(Project, Count) :-
    vulnerable_project(Project, _, _, _, _) |>
    do fn:group_by(Project),
    let Count = fn:count().

# Projects with no vulnerabilities
secure_project(Project) :-
    project(Project, _),
    !vulnerable_project(Project, _, _, _, _).

# Direct vulnerability path (base case - no list pattern needed)
has_direct_vuln(Project, Library, CVE) :-
    contains_jar_directly(Project, Library, Version),
    cve_affects(Library, Version, CVE, _).

# Transitive vulnerability path
has_transitive_vuln(Project, Library, CVE) :-
    project_depends(Project, Dep),
    has_direct_vuln(Dep, Library, CVE).

has_transitive_vuln(Project, Library, CVE) :-
    project_depends(Project, Dep),
    has_transitive_vuln(Dep, Library, CVE).

# Summary statistics
total_projects(N) :-
    project(_, _) |>
    do fn:group_by(),
    let N = fn:count().

total_vulnerabilities(N) :-
    vulnerable_project(_, _, _, _, _) |>
    do fn:group_by(),
    let N = fn:count().

# =============================================================================
# Queries (for REPL)
# =============================================================================

# ?vulnerable_project(Project, Library, Version, CVE, Severity)
# ?critical_vulnerability(Project, Library, CVE)
# ?vulnerability_count(Project, Count)
# ?secure_project(Project)
# ?has_transitive_vuln(/proj/webapp, Library, CVE)
